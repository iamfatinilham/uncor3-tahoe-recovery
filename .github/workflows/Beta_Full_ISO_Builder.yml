name: Latest Beta (Full ISO) Builder

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      # 1. Free up disk space to prevent "No space left on device" errors
      - name: Maximize Build Space
        run: |
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /Users/runner/Library/Android
          sudo rm -rf /Users/runner/.dotnet
          
      - name: Clone gibMacOS
        run: |
          git clone https://github.com/corpnewt/gibMacOS.git

      - name: Download macOS Installer (latest beta)
        run: |
          python ./gibMacOS/gibMacOS.py -c developer -v Tahoe -m 26 -o /tmp/Tahoe-beta-latest

      - name: Install the assistant
        run: |
          sudo installer -pkg /tmp/Tahoe-beta-latest/InstallAssistant.pkg -target /
          
      # CRITICAL: Delete the downloaded PKG immediately to save ~12GB of space
      - name: Clean up PKG
        run: |
          rm -rf /tmp/Tahoe-beta-latest
          echo "Deleted downloaded PKG to save space."

      - name: Generate macOS ISO (Final Fix)
        run: |
          INSTALLER=$(ls -d /Applications/Install*.app | head -n 1 || true)
          if [ ! -d "$INSTALLER" ]; then
            echo "Could not find Install macOS app in /Applications"
            exit 1
          fi
          
          # Final safe size: 20 GB (20000 MB)
          SAFE_SIZE_MB=20000 
          
          # Create a fixed size DMG (20 GB)
          sudo hdiutil create -o /tmp/Tahoe -size ${SAFE_SIZE_MB}m -volname 'Tahoe' -layout SPUD -fs HFS+J
          
          # Mount it
          sudo hdiutil attach /tmp/Tahoe.dmg -noverify -mountpoint /Volumes/Tahoe
          
          echo "Creating install media..."
          sudo "$INSTALLER/Contents/Resources/createinstallmedia" --volume /Volumes/Tahoe --nointeraction

          # Unmount the volume so we can convert it
          echo "Unmounting..."
          MOUNT_POINT=$(ls -d /Volumes/Install* | head -n 1)
          sudo hdiutil detach "$MOUNT_POINT" -force

          # Convert DMG to ISO (CDR format). This file will be owned by root.
          echo "Converting to ISO..."
          hdiutil convert /tmp/Tahoe.dmg -format UDTO -o /tmp/Tahoe.cdr
          
          # FIX: Use sudo to rename the root-owned file
          sudo mv /tmp/Tahoe.cdr /tmp/Tahoe-Full.iso
          
          # Clean up the original root-owned DMG file
          sudo rm /tmp/Tahoe.dmg

      - name: Generate dynamic tag
        id: tagger
        run: echo "TAG=tahoe-$(date +'%Y-%m-%d-%H-%M-%S')_run_${{ github.run_number }}" >> $GITHUB_ENV
      - name: Rename ISO using the tag
        run: mv "/tmp/Tahoe-Full.iso" "/tmp/${TAG}.iso"

      - name: Upload Full ISO
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.TAG }}
          # FIX: Change the path to match the name created by the 'mv' command above
          path: /tmp/${{ env.TAG }}.iso
          compression-level: 0 # No compression to speed up the massive upload

#      - name: Publish ISO to GitHub Release
#        uses: softprops/action-gh-release@v2
#        with:
#          tag_name: ${{ env.TAG }}
#          name: ${{ env.TAG }}.iso
#          body: |
#            Automatic build of the latest macOS Tahoe full installer ISO.
#          files: /tmp/${{ env.TAG }}.iso
#        env:
#          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
